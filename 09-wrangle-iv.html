<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>EDH 7916 - IV: Tidyverse Tricks &amp; SQL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./apple-touch-icon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="site-attachments/styles.css">
<meta property="og:title" content="EDH 7916 - IV: Tidyverse Tricks &amp; SQL">
<meta property="og:image" content="https://capaldi.info/7916/apple-touch-icon.png">
<meta property="og:site_name" content="EDH 7916">
<meta property="og:image:height" content="180">
<meta property="og:image:width" content="180">
<meta name="twitter:title" content="EDH 7916 - IV: Tidyverse Tricks &amp; SQL">
<meta name="twitter:image" content="https://capaldi.info/7916/apple-touch-icon.png">
<meta name="twitter:image-height" content="180">
<meta name="twitter:image-width" content="180">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-wrangle-i.html">Data Wrangling</a></li><li class="breadcrumb-item"><a href="./09-wrangle-iv.html">IV: Tidyverse Tricks &amp; SQL</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">EDH 7916</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Homepage</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./syllabus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-set-install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">I: Installing R &amp; RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-set-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">II: Reading Data &amp; IPEDS</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Data Wrangling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-wrangle-i.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">I: Enter the tidyverse</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-wrangle-ii.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">II: Appending, joining, &amp; reshaping data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-wrangle-iii.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">III: Working with strings &amp; dates</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-wrangle-iv.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">IV: Tidyverse Tricks &amp; SQL</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Data Visualization</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-viz-i.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">I: Basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-viz-ii.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">II: Customization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-viz-iii.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">III: Maps &amp; Spatial Data (Feat. APIs)</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Quarto</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-quarto-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reproducable Reports with Quarto</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Programming</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-pro-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">I: Functions &amp; Loops</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-pro-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">II: Modeling Basics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-final.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Final Project</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Extra Credit</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./x-01-git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">I: Git &amp; GitHub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./x-02-dload-ipeds.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">II: Skinner’s Download IPEDS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./x-03-vanilla.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">III: Data Wrangling I Redux: Vanilla R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./x-04-skinner-phil.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IV: Skinner’s Philosophy of Data Wrangling</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03-wrangle-i.html">Data Wrangling</a></li><li class="breadcrumb-item"><a href="./09-wrangle-iv.html">IV: Tidyverse Tricks &amp; SQL</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">IV: Tidyverse Tricks &amp; SQL</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Lesson</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Assignment</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p><a href="./r-scripts/09-wrangle-iv.R"><i class="fa-solid fa-code" aria-label="code"></i> R Code</a></p>
<ul>
<li>In this brand new lesson for 2024 we are going to cover two main topics
<ol type="1">
<li>Some more advanced <code>tidyverse</code> commands that can save a lot of time</li>
<li>How the <code>tidyverse</code> we have learned so far relates to <code>SQL</code> (Structured Query Language) commonly used to access databases</li>
</ol></li>
</ul>
<section id="tidyverse-tricks" class="level2">
<h2 data-anchor-id="tidyverse-tricks">Tidyverse Tricks</h2>
<ul>
<li>Now you have a decent grasp on the core functions of <code>tidyverse</code> we can start exploring some helper functions that can make our lives much easier!</li>
<li>These commands have been chosen as I have personally found them wildly helpful in working with IPEDS and other data
<ul>
<li>To demonstrate, we are going to use IPEDS finance data files for 2018/19 school year</li>
<li>Notice: IPEDS uses separate data files for public <code>_f1a</code> non-profit <code>_f2</code> and for-profit <code>_f3</code> colleges</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>df_18_pub <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"ipeds-finance"</span>, <span class="st">"f1819_f1a_rv.csv"</span>))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df_18_np <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"ipeds-finance"</span>, <span class="st">"f1819_f2_rv.csv"</span>))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>df_18_fp <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"ipeds-finance"</span>, <span class="st">"f1819_f3_rv.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>First, since there should be no college in more than one of these data files, and each college only has one row, we can <code>bind_rows</code> to stack each one on top of the other
<ul>
<li>Then run a quick test to check no UNITID appears more than once (no duplicates)</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df_18 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_18_pub, df_18_np, df_18_fp)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>df_18 <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(UNITID) <span class="sc">|&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 2
# ℹ 2 variables: UNITID &lt;dbl&gt;, n &lt;int&gt;</code></pre>
</div>
</div>
<ul>
<li>Notice: we now have 6069 obs. of 663 variables
<ul>
<li>Does this pass the “eyeball test”?
<ul>
<li>The number of obs. looks right as it is just sum of the obs. from the 3 dfs</li>
<li>The number of vars. may look concerning at first
<ul>
<li>Why, if all we did was “stack” rows on top of each other, would the number of vars increase?</li>
</ul></li>
</ul></li>
</ul></li>
<li>What we have created is a somewhat “sparse” data frame, as each institution category has differently named variables (in part due to differing reporting requirements)</li>
</ul>
<p>Our data looks something like this</p>
<table class="table">
<caption>Depiction of Sparse DataFrame</caption>
<thead>
<tr class="header">
<th></th>
<th>Public Vars</th>
<th>Non-Profit Vars</th>
<th>For-Profit Vars</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Public IDs</td>
<td><code>values</code></td>
<td><code>NA</code></td>
<td><code>NA</code></td>
</tr>
<tr class="even">
<td>Non-Profit IDs</td>
<td><code>NA</code></td>
<td><code>values</code></td>
<td><code>NA</code></td>
</tr>
<tr class="odd">
<td>For-Profit IDs</td>
<td><code>NA</code></td>
<td><code>NA</code></td>
<td><code>values</code></td>
</tr>
</tbody>
</table>
<ul>
<li>Hmm, sounds like this could get tricky… Luckily <code>tidyverse</code> is here to help!</li>
</ul>
<section id="coelesce-data-split-across-columns" class="level3">
<h3 data-anchor-id="coelesce-data-split-across-columns"><code>coelesce()</code> Data Split Across Columns</h3>
<ul>
<li>Let’s say we want to combine this information into one variable to show how much all institutions spend on instruction, research, and student services, respectively
<ul>
<li>Side note: If combining variables like this in your own work, check the code book to ensure you know what you’re combining and why</li>
<li>In this case, the variables we will be combining appear to be close equivalents</li>
</ul></li>
<li>First things first, let’s <code>select()</code> the relevant variables from the larger data set using the IPEDS dictionary files
<ul>
<li>Quick question: How did I find the variable names to use below?</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_18 <span class="ot">&lt;-</span> df_18 <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(UNITID,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>         F1C011, F1C021, F1C061,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>         F2E011, F2E021, F2E051,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>         F3E011, F3E02A1, F3E03B1)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_18[<span class="dv">100</span><span class="sc">:</span><span class="dv">105</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 10
  UNITID    F1C011  F1C021   F1C061 F2E011 F2E021 F2E051 F3E011 F3E02A1 F3E03B1
   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 109819  81760530       0 13575072     NA     NA     NA     NA      NA      NA
2 109907   8880360  241606  5093396     NA     NA     NA     NA      NA      NA
3 110246  40754283       0 13656135     NA     NA     NA     NA      NA      NA
4 110334  54226032       0 18432007     NA     NA     NA     NA      NA      NA
5 110398  28937539       0  5591440     NA     NA     NA     NA      NA      NA
6 110422 219559005 2847727 78536402     NA     NA     NA     NA      NA      NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_18[<span class="dv">3000</span><span class="sc">:</span><span class="dv">3005</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 10
  UNITID F1C011 F1C021 F1C061   F2E011 F2E021   F2E051 F3E011 F3E02A1 F3E03B1
   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 206862     NA     NA     NA 17364863      0  8130862     NA      NA      NA
2 207157     NA     NA     NA  1055254      0   975876     NA      NA      NA
3 207324     NA     NA     NA 16367709      0  9449815     NA      NA      NA
4 207403     NA     NA     NA 14538443      0 10456812     NA      NA      NA
5 207458     NA     NA     NA 39875546      0 12083472     NA      NA      NA
6 207582     NA     NA     NA 26366669 101944 12445590     NA      NA      NA</code></pre>
</div>
</div>
<!--

- For the sake of demonstration, let me show how to do this for instruction without our first "tidyverse trick"
  - Fun fact: I did something very close to this in my final project when I took this class!


::: {.cell}

```{.r .cell-code}
## Split back up into separate files
pub <- df_18 |> filter(!is.na(F1C011)) |>
  ## Rename the variable
  rename(inst_spend = F1C011) |>
  ## Drop the other variables
  select(UNITID, inst_spend)
np <- df_18 |> filter(!is.na(F2E011)) |>
  rename(inst_spend = F2E011) |>
  select(UNITID, inst_spend)
fp <- df_18 |> filter(!is.na(F3E011)) |>
  rename(inst_spend = F3E011) |>
  select(UNITID, inst_spend)
## Re-bind the colleges back up
rebind <- bind_rows(pub, np, fp)
```
:::


- Quite a lot of code, and that is a relatively simple case

-->
<ul>
<li>Luckily, tidyverse has a command to help us, <code>coalesce()</code>
<ul>
<li>Returns the first non-missing value across any number of columns
<ul>
<li>This works perfectly in situations like this, when you only have one data point for each row, it could just be in any column</li>
</ul></li>
</ul></li>
</ul>
<!--

- Let's check, are they the same?


::: {.cell}

```{.r .cell-code}
all.equal(rebind, coalesce)
```

::: {.cell-output .cell-output-stdout}

```
[1] "Modes: list, function"                               
[2] "Lengths: 2, 1"                                       
[3] "names for target but not for current"                
[4] "Attributes: < Modes: list, NULL >"                   
[5] "Attributes: < Lengths: 2, 0 >"                       
[6] "Attributes: < names for target but not for current >"
[7] "Attributes: < current is not list-like >"            
[8] "current is not list-like"                            
```


:::
:::


Yep! So let's do all the columns and get a clean data frame

-->
<p>let’s do all the columns and get a clean data frame</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df_18_clean <span class="ot">&lt;-</span> df_18 <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inst_spend =</span> <span class="fu">coalesce</span>(F1C011, F2E011, F3E011),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">rsch_spend =</span> <span class="fu">coalesce</span>(F1C021, F2E021, F3E02A1),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">serv_spend =</span> <span class="fu">coalesce</span>(F1C061, F2E051, F3E03B1)) <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(UNITID, inst_spend, rsch_spend, serv_spend)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_18_clean[<span class="dv">100</span><span class="sc">:</span><span class="dv">105</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  UNITID inst_spend rsch_spend serv_spend
   &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1 109819   81760530          0   13575072
2 109907    8880360     241606    5093396
3 110246   40754283          0   13656135
4 110334   54226032          0   18432007
5 110398   28937539          0    5591440
6 110422  219559005    2847727   78536402</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_18_clean[<span class="dv">3000</span><span class="sc">:</span><span class="dv">3005</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  UNITID inst_spend rsch_spend serv_spend
   &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1 206862   17364863          0    8130862
2 207157    1055254          0     975876
3 207324   16367709          0    9449815
4 207403   14538443          0   10456812
5 207458   39875546          0   12083472
6 207582   26366669     101944   12445590</code></pre>
</div>
</div>
<ul>
<li>This is a real time saver if working with IPEDS finance data</li>
<li>Another use case for this might be if you had 30 columns one for each test date and rows for student scores, they all took the test on one of the dates, you want a single column for student scores, but it could have been recorded in any of the date columns</li>
</ul>
</section>
<section id="finding-if_any-issues" class="level3">
<h3 data-anchor-id="finding-if_any-issues">Finding <code>if_any()</code> Issues</h3>
<ul>
<li>Although compliance is a federal requirement, completeness of reporting remains a struggle when using IPEDS data</li>
<li>From the snapshots of the data we have seen so far, it seems that there’s a good number of $0 reports for these values</li>
<li>Let’s try and get a data frame containing only institutions that reported $0 for one of these spending categories</li>
</ul>
<!--

- Without the helper function


::: {.cell}

```{.r .cell-code}
df_0_inst <- df_18_clean |> filter(inst_spend == 0)
df_0_rsch <- df_18_clean |> filter(rsch_spend == 0)
df_0_serv <- df_18_clean |> filter(serv_spend == 0)
df_0 <- bind_rows(df_0_inst, df_0_rsch, df_0_serv)

## Plus we end up with duplicates
df_0 |>
  count(UNITID) |>
  filter(n > 1)
```

::: {.cell-output .cell-output-stdout}

```
# A tibble: 375 × 2
   UNITID     n
    <dbl> <int>
 1 100733     3
 2 103529     3
 3 106324     2
 4 106360     2
 5 106494     2
 6 107099     2
 7 108056     2
 8 108269     2
 9 111045     2
10 111708     2
# ℹ 365 more rows
```


:::
:::


-->
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_0 <span class="ot">&lt;-</span> df_18_clean <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">if_any</span>(<span class="fu">everything</span>(), <span class="sc">~</span> . <span class="sc">==</span> <span class="dv">0</span>)) <span class="do">## h/t https://stackoverflow.com/questions/69585261/dplyr-if-any-and-numeric-filtering</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,803 × 4
   UNITID inst_spend rsch_spend serv_spend
    &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
 1 100733          0          0          0
 2 100760    8740330          0    3605430
 3 100812   17101084          0    2918417
 4 101028    6298586          0    2062946
 5 101143    7532616          0    3094312
 6 101161   23308825          0    7205781
 7 101240   20593662          0    7278193
 8 101286   17872473          0    4563448
 9 101295   20945006          0    6225596
10 101301    5373481          0    3216811
# ℹ 4,793 more rows</code></pre>
</div>
</div>
<ul>
<li>Let’s walk through this code
<ol type="1">
<li>Assign our results to a new object called <code>df_0</code></li>
<li>Take <code>df_18_clean</code> and pipe it into filter</li>
<li>Inside <code>filter()</code> we have our <code>if_any</code> helper function, which has two arguments</li>
</ol>
<ol type="i">
<li><code>.cols</code> which columns to look across - Here we have just gone for all columns with <code>everything()</code>, but you could input a list of specific column names, or another selection function like <code>where(is.numeric))</code></li>
<li><code>.fns</code> function to test the columns against - Here we have use <code>~ . == 0</code>
<ul>
<li>We haven’t used <code>purrr</code> from <code>tidyverse</code> in this class, but the <code>~</code> comes from there, in short, it starts a very simple function for us
<ul>
<li>The function takes any value <code>.</code> and asks if it equals 0 <code>== 0</code></li>
<li>If the function returns <code>TRUE</code> (as in it equals 0) for any column, that row will be <code>filter()</code>-ed in</li>
</ul></li>
</ul></li>
</ol></li>
</ul>
</section>
<section id="working-across-multiple-columns" class="level3">
<h3 data-anchor-id="working-across-multiple-columns">Working <code>across()</code> Multiple Columns</h3>
<ul>
<li>Now let’s explore that data a little more with <code>if_any()</code>’s sister function <code>across()</code>
<ul>
<li>Internally <code>if_any()</code> and <code>across()</code> are set up the same
<ul>
<li>They both take
<ol type="i">
<li><code>.cols</code> which columns to look across</li>
<li><code>.fns</code> function to test the columns against</li>
</ol></li>
</ul></li>
<li>The difference between them comes down to which function they work in
<ul>
<li><code>if_any()</code> is used in a handful of functions like <code>filter()</code></li>
<li><code>across</code> is used in most functions like <code>summarize()</code> and <code>mutate()</code>
<ul>
<li>If you try to use <code>across()</code> where you aren’t meant to <code>tidyverse</code> will throw you a warning</li>
</ul></li>
</ul></li>
</ul></li>
<li>Here, we will use the <code>across</code> function inside <code>count()</code> to get a breakdown of which spending categories are unreported most often</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>df_0 <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>UNITID) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> . <span class="sc">==</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 4
  inst_spend rsch_spend serv_spend     n
  &lt;lgl&gt;      &lt;lgl&gt;      &lt;lgl&gt;      &lt;int&gt;
1 FALSE      FALSE      TRUE          12
2 FALSE      TRUE       FALSE       4411
3 FALSE      TRUE       TRUE         336
4 TRUE       FALSE      FALSE          5
5 TRUE       FALSE      TRUE           2
6 TRUE       TRUE       FALSE         12
7 TRUE       TRUE       TRUE          25</code></pre>
</div>
</div>
<ul>
<li>The internal logic of the <code>across()</code> here is identical to the <code>if_any()</code> above
<ul>
<li><code>everything()</code> works across all columns, <code>~ . == 0</code> is a simple function to test if any value equals 0</li>
</ul></li>
<li><code>across()</code> just works in the <code>count()</code> function
<ul>
<li>Outputs a count table counting combinations of the variables equaling 0
<ul>
<li>By far the most common variable to report zero is research spending, with 4411 reporting only that variable as 0</li>
<li>25 schools reported 0 for all three variables</li>
</ul></li>
</ul></li>
<li>Although we’ve only been working across 3 variables in these examples, the power of these commands is that they can work across an unlimited number of columns, so the bigger your data, the more should be thinking <code>across()</code> and <code>if_any()</code></li>
</ul>
</section>
<section id="moving-beyond-ifelse-with-case_when" class="level3">
<h3 data-anchor-id="moving-beyond-ifelse-with-case_when">Moving Beyond <code>ifelse()</code> with <code>case_when()</code></h3>
<ul>
<li><p>Keeping digging into differences in spending categories, next, let’s say we want to create a new variable that says which order the three spending categories were for each school</p></li>
<li><p>Let’s walk through the <code>case_when()</code> code</p>
<ol type="1">
<li>Much like we used <code>ifelse()</code> inside mutate to make a new variable in <a href="./03-wrangle-i.html">Data Wranling I</a>, we can use <code>case_when()</code> when we have more than a binary test</li>
</ol>
<ul>
<li><code>case_when()</code> goes down the list of conditions in order until it finds one that it answers <code>TRUE</code> at which point it returns the value on the right hand side of the <code>~</code></li>
<li>Here we have listed out all possible orders of spending categories with a label for each scenario</li>
</ul>
<ol start="2" type="1">
<li>Unlike <code>ifelse()</code> there is a unique danger that would don’t cover every eventuality with your conditions</li>
</ol>
<ul>
<li>This is why I like to end with <code>TRUE</code>, as that will be <code>TRUE</code> no matter what
<ul>
<li>I then assign some kind of catch-all phrase that makes me know I made an error (it will just <code>NA</code> if you don’t do this)</li>
</ul></li>
</ul>
<ol start="3" type="1">
<li>To check if a <code>case_when()</code> worked, I like to pipe it into a <code>count()</code> for the new variable we made</li>
</ol></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_18_clean <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">highest_cat =</span> <span class="fu">case_when</span>(inst_spend <span class="sc">&gt;</span> rsch_spend <span class="sc">&amp;</span> rsch_spend <span class="sc">&gt;</span> serv_spend <span class="sc">~</span> <span class="st">"inst_rsch_serv"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                                 inst_spend <span class="sc">&gt;</span> serv_spend <span class="sc">&amp;</span> serv_spend <span class="sc">&gt;</span> rsch_spend <span class="sc">~</span> <span class="st">"inst_serv_rsch"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                                 rsch_spend <span class="sc">&gt;</span> inst_spend <span class="sc">&amp;</span> inst_spend <span class="sc">&gt;</span> serv_spend <span class="sc">~</span> <span class="st">"rsch_inst_serv"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                                 rsch_spend <span class="sc">&gt;</span> serv_spend <span class="sc">&amp;</span> serv_spend <span class="sc">&gt;</span> inst_spend <span class="sc">~</span> <span class="st">"rsch_serv_inst"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                                 serv_spend <span class="sc">&gt;</span> inst_spend <span class="sc">&amp;</span> inst_spend <span class="sc">&gt;</span> rsch_spend <span class="sc">~</span> <span class="st">"serv_inst_rsch"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                                 serv_spend <span class="sc">&gt;</span> rsch_spend <span class="sc">&amp;</span> rsch_spend <span class="sc">&gt;</span> inst_spend <span class="sc">~</span> <span class="st">"serv_rsch_inst"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"You missed a condition Matt"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(highest_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
  highest_cat                     n
  &lt;chr&gt;                       &lt;int&gt;
1 You missed a condition Matt   377
2 inst_rsch_serv                262
3 inst_serv_rsch               5004
4 rsch_inst_serv                 35
5 rsch_serv_inst                  4
6 serv_inst_rsch                384
7 serv_rsch_inst                  3</code></pre>
</div>
</div>
<ul>
<li><p>Looks like I missed something in my <code>case_when()</code>, can anyone guess what it is?</p></li>
<li><p>What would happen to this school</p>
<ul>
<li>inst_spend 35,000,000</li>
<li>rsch_spend 20,000,000</li>
<li>serv_spend 20,000,000
<ul>
<li>As I have only specified for all order of categories being “greater than” the other, situations where two categories are equal slip through the cracks
<ul>
<li>This was a genuine mistake when writing the lesson, precisely why I always include that catch all</li>
</ul></li>
</ul></li>
</ul></li>
<li><p>Let’s see how our results change if I use “greater than or equal to” signs</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_18_clean <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">highest_cat =</span> <span class="fu">case_when</span>(inst_spend <span class="sc">&gt;=</span> rsch_spend <span class="sc">&amp;</span> rsch_spend <span class="sc">&gt;=</span> serv_spend <span class="sc">~</span> <span class="st">"inst_rsch_serv"</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                 inst_spend <span class="sc">&gt;=</span> serv_spend <span class="sc">&amp;</span> serv_spend <span class="sc">&gt;=</span> rsch_spend <span class="sc">~</span> <span class="st">"inst_serv_rsch"</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                                 rsch_spend <span class="sc">&gt;=</span> inst_spend <span class="sc">&amp;</span> inst_spend <span class="sc">&gt;=</span> serv_spend <span class="sc">~</span> <span class="st">"rsch_inst_serv"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                                 rsch_spend <span class="sc">&gt;=</span> serv_spend <span class="sc">&amp;</span> serv_spend <span class="sc">&gt;=</span> inst_spend <span class="sc">~</span> <span class="st">"rsch_serv_inst"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                                 serv_spend <span class="sc">&gt;=</span> inst_spend <span class="sc">&amp;</span> inst_spend <span class="sc">&gt;=</span> rsch_spend <span class="sc">~</span> <span class="st">"serv_inst_rsch"</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                                 serv_spend <span class="sc">&gt;=</span> rsch_spend <span class="sc">&amp;</span> rsch_spend <span class="sc">&gt;=</span> inst_spend <span class="sc">~</span> <span class="st">"serv_rsch_inst"</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"You missed a condition Matt"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(highest_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  highest_cat        n
  &lt;chr&gt;          &lt;int&gt;
1 inst_rsch_serv   624
2 inst_serv_rsch  5005
3 rsch_inst_serv    37
4 rsch_serv_inst     4
5 serv_inst_rsch   396
6 serv_rsch_inst     3</code></pre>
</div>
</div>
<ul>
<li><p>No missing conditions this time, hooray!</p></li>
<li><p>Also, I’m definitely surprised how few institutions spend most on research, and just how many spend instruction &gt; services &gt; research</p>
<ul>
<li>Does this surprise you as well?</li>
</ul></li>
</ul>
</section>
<section id="tidyverse-tricks-summary" class="level3">
<h3 data-anchor-id="tidyverse-tricks-summary">Tidyverse Tricks Summary</h3>
<ul>
<li>I hope some of these more advanced <code>tidyverse</code> commands will prove helpful, particularly as you move into the world of bigger data sets with more variables!</li>
<li>Next, we are going to revisit some code from <a href="./03-wrangle-i.html">Data Wrangling I</a> and <a href="./04-wrangle-ii.html">Data Wrangling II</a> and see how it translates to <code>SQL</code></li>
</ul>
</section>
</section>
<section id="from-tidyverse-to-sql" class="level2">
<h2 data-anchor-id="from-tidyverse-to-sql">From <code>tidyverse</code> to <code>SQL</code></h2>
<ul>
<li>For this section, we are going to see how tasks from <a href="./04-wrangle-ii.html">Data Wrangling II</a> could be performed using <code>SQL</code>, a common tool used to work with databases</li>
</ul>
<section id="what-is-sql" class="level3">
<h3 data-anchor-id="what-is-sql">What is <code>SQL</code>?</h3>
<ul>
<li>SQL, short for Structured Query Language, is a way of retrieving, modifying, and storing data from databases. For a solid background page on <code>SQL</code> see <a href="https://aws.amazon.com/what-is/sql/">this overview from AWS</a></li>
<li>One of thing that confuses people about SQL is that there’s the base language of SQL that all SQL-based products share and then multiple commercial product implementations of SQL that take the base language and add additional and unique functions
<ul>
<li>The <code>dbplyr</code> package we are going to use below attempts to mimic the implementation we tell it to</li>
</ul></li>
<li>A key difference between <code>R</code> and <code>SQL</code> is that we don’t have the option to assign our results to an object like we do with <code>R</code>
<ul>
<li>Instead, an <code>SQL</code> query is simply the code to retrieve the data, what happens to that data (e.g., does it show up on your screen, is it saved somewhere, etc.) will be determined by the <code>SQL</code>-based software you’re using</li>
</ul></li>
</ul>
</section>
<section id="how-does-sql-relate-to-this-class" class="level3">
<h3 data-anchor-id="how-does-sql-relate-to-this-class">How does <code>SQL</code> Relate to this Class?</h3>
<ul>
<li>First, <code>SQL</code> is a really important tool for data management jobs in higher education. Larger institutions like UF almost certainly store their institutional data in a database that uses <code>SQL</code>
<ul>
<li>However, it is rarely taught in Higher Ed degree programs, so, this little intro already sets you up for success</li>
</ul></li>
<li>Second, the <code>tidyverse</code> language we have been learning this semester is in many ways similar to <code>SQL</code>
<ul>
<li>In fact, a lot of the functions and function names in <code>tidyverse</code> come directly from <code>SQL</code></li>
<li>There’s an entire package <code>dbplyr</code> which can translate our standard <code>dplyr</code> commands to <code>SQL</code> queries
<ul>
<li>That’s what we are going to play around with today!</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="data-wrangling-ii-in-sql" class="level3">
<h3 data-anchor-id="data-wrangling-ii-in-sql">Data Wrangling II in <code>SQL</code></h3>
<ul>
<li>To explore <code>SQL</code> in a familiar environment, we are going to re-visit <a href="./04-wrangle-ii.html">Data Wrangling II</a>
<ul>
<li>While more complicated data wrangling is certainly possible in <code>SQL</code> the most common use in education is to pull or “query” data out of institutional databases with some simple summaries or joins</li>
<li></li>
</ul></li>
<li>First, we have to simulate an <code>SQL</code> database for <code>dbplyr</code>
<ul>
<li>This tells <code>dbplyr</code> exactly how to translate our code</li>
<li>For today’s class, we will simulate a Microsoft Access database with the <code>simulate_access()</code> command</li>
</ul></li>
<li>Second, instead of a normal <code>df</code>, we want R to pretend that <code>df</code> is a table in a database, which we do with the <code>memdb_frame()</code> command
<ul>
<li>If you’re curious what this command does, try <code>print(df)</code> and <code>print(db)</code> to see the difference</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(<span class="st">"data"</span>, <span class="st">"sch-test"</span>, <span class="st">"all-schools.csv"</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>microsoft_access <span class="ot">&lt;-</span> <span class="fu">simulate_access</span>()</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>db <span class="ot">&lt;-</span> <span class="fu">memdb_frame</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="create-summary-table" class="level4">
<h4 data-anchor-id="create-summary-table">Create Summary Table</h4>
<ul>
<li>Our first command is pretty simple, we want to group our data by year then calculate the mean test score, which will give us average test scores for each year</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># https://stackoverflow.com/questions/76724279/syntax-highlight-quarto-output</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>df_sum <span class="ot">&lt;-</span> db <span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="do">## grouping by year so average within each year</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="do">## get mean(&lt;score&gt;) for each test</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">math_m =</span> <span class="fu">mean</span>(math),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">read_m =</span> <span class="fu">mean</span>(read),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">science_m =</span> <span class="fu">mean</span>(science)) <span class="sc">|&gt;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb22"><pre class="sourceCode SQL code-with-copy"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>SQL<span class="op">&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  `year`,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(`math`) <span class="kw">AS</span> `math_m`,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(`read`) <span class="kw">AS</span> `read_m`,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(`science`) <span class="kw">AS</span> `science_m`</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `dbplyr_001`</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> `year`</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>We start with <code>SELECT</code>
<ul>
<li>We list out what we want, which is the <code>year</code> variable and <code>AVG()</code>s of math, reading, and science test scores</li>
</ul></li>
<li>We are taking them from our simulated databases <code>dbplyr_002</code> which we want <code>GROUP BY</code>-ed year
<ul>
<li>As <code>SQL</code> code is nested, we can’t read it top to bottom, the <code>GROUP BY</code> takes place as we pull the data out of <code>dbplyr_002</code> before we calculate the <code>AVG()</code></li>
</ul></li>
</ul>
</section>
<section id="left-join" class="level4">
<h4 data-anchor-id="left-join">Left-Join</h4>
<ul>
<li>Next, we want to join these averages back into the the main data frame</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_joined <span class="ot">&lt;-</span> db <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="do">## pipe into left_join to join with df_sum using "year" as key</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(df_sum, <span class="at">by =</span> <span class="st">"year"</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb24"><pre class="sourceCode SQL code-with-copy"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>SQL<span class="op">&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> `dbplyr_001`.<span class="op">*</span>, `math_m`, `read_m`, `science_m`</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `dbplyr_001`</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> (</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    `year`,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">AVG</span>(`math`) <span class="kw">AS</span> `math_m`,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">AVG</span>(`read`) <span class="kw">AS</span> `read_m`,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">AVG</span>(`science`) <span class="kw">AS</span> `science_m`</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> `dbplyr_001`</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> `year`</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> `RHS`</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> (`dbplyr_001`.`year` <span class="op">=</span> `RHS`.`year`)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>We see our preceding query nested inside our new query from the second <code>SELECT</code> statement to the <code>GROUP BY</code> statement
<ul>
<li>That all sits become <code>RHS</code> inside our <code>LEFT JOIN</code> statement</li>
</ul></li>
<li>We see this is joined <code>ON</code> the <code>year</code> variable with the original data <code>dbplyr_002</code></li>
</ul>
</section>
<section id="pivot-longer" class="level4">
<h4 data-anchor-id="pivot-longer">Pivot-Longer</h4>
<ul>
<li>Our next query pivots the data longer, which remember from our original lesson take the math, reading, and science score columns, and turns them into one column for score type and column for score</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df_long <span class="ot">&lt;-</span> db <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="do">## cols: current test columns</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="do">## names_to: where "math", "read", and "science" will go</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="do">## values_to: where the values in cols will go</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"math"</span>,<span class="st">"read"</span>,<span class="st">"science"</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"test"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"score"</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb26"><pre class="sourceCode SQL code-with-copy"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>SQL<span class="op">&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> `school`, `year`, <span class="st">'math'</span> <span class="kw">AS</span> `test`, `math` <span class="kw">AS</span> `score`</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `dbplyr_001`</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> `school`, `year`, <span class="st">'read'</span> <span class="kw">AS</span> `test`, `read` <span class="kw">AS</span> `score`</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `dbplyr_001`</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> `school`, `year`, <span class="st">'science'</span> <span class="kw">AS</span> `test`, `science` <span class="kw">AS</span> `score`</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `dbplyr_001`</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>What we see here is a bit different, as it’s manual</li>
<li>First we <code>SELECT</code> school and year as they are, math as <code>test</code> and <code>math</code> as <code>score</code></li>
<li>This then <code>UNION ALL</code>-ed (think <code>bind_rows</code> style stacking) with the same query for <code>reading</code> and then again for <code>science</code></li>
</ul>
</section>
<section id="pivot-wider" class="level4">
<h4 data-anchor-id="pivot-wider">Pivot-Wider</h4>
<ul>
<li>Next, let’s pivot that data back wide</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_wide <span class="ot">&lt;-</span> df_long <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="do">## names_from: values in this column will become new column names</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="do">## values_from: values in this column will become values in new cols</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"test"</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">values_from =</span> <span class="st">"score"</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb28"><pre class="sourceCode SQL code-with-copy"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>SQL<span class="op">&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  `school`,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  `year`,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> (`test` <span class="op">=</span> <span class="st">'math'</span>) <span class="cf">THEN</span> `score` <span class="cf">END</span>) <span class="kw">AS</span> `math`,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> (`test` <span class="op">=</span> <span class="st">'read'</span>) <span class="cf">THEN</span> `score` <span class="cf">END</span>) <span class="kw">AS</span> `read`,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(<span class="cf">CASE</span> <span class="cf">WHEN</span> (`test` <span class="op">=</span> <span class="st">'science'</span>) <span class="cf">THEN</span> `score` <span class="cf">END</span>) <span class="kw">AS</span> `science`</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> `school`, `year`, <span class="st">'math'</span> <span class="kw">AS</span> `test`, `math` <span class="kw">AS</span> `score`</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> `dbplyr_001`</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> `school`, `year`, <span class="st">'read'</span> <span class="kw">AS</span> `test`, `read` <span class="kw">AS</span> `score`</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> `dbplyr_001`</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> `school`, `year`, <span class="st">'science'</span> <span class="kw">AS</span> `test`, `science` <span class="kw">AS</span> `score`</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> `dbplyr_001`</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> `q01`</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> `school`, `year`</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<ul>
<li>Our first <code>SELECT</code> statement asks for school and year, then…</li>
<li>We use <code>CASE WHEN</code> for each type of test, creating a new variable for each subject <code>WHEN</code> the test type equaled that subject</li>
<li>Beneath that, we see our previous query that creates the long data that we pivoted back wider</li>
</ul>
</section>
</section>
</section>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>There is no homework assignment associated with this lesson. Instead, your initial analysis for your reproducible report is due Sunday at 11:59pm. See the <a href="./99-final.html">final project</a> for details.</p>
</div>
</div>
</div>
<!--

### Data Wrangling I in `SQL`





- In [Data Wrangling I](03-wrangle-i.qmd) we were given the following task

> Using HSLS09 data, figure out average differences in college degree expectations
> across census regions; for a first pass, ignore missing values and
> use the higher of student and parental expectations if an
> observation has both.

- Our final piped together code to answer the question looked like this


::: {.cell}

```{.r .cell-code}
df <- read_csv(file.path("data", "hsls-small.csv"))

df |>
  ## select columns we want
  select(stu_id, x1stuedexpct, x1paredexpct, x1region) |>
  ## If expectation is -8, -9. or 11, make it NA
  mutate(student_exp = ifelse(x1stuedexpct %in% list(-8, -9, 11), NA, x1stuedexpct),
         parent_exp = ifelse(x1paredexpct %in% list(-8, -9, 11), NA, x1paredexpct)) |>
  ## Make a new variable called high_exp that is the higher or parent and student exp
  mutate(high_exp = ifelse(student_exp > parent_exp, student_exp, parent_exp)) |>
  ## If one exp is NA but the other isn't, keep the value not the NA
  mutate(high_exp = ifelse(is.na(high_exp) & !is.na(student_exp), student_exp, high_exp),
         high_exp = ifelse(is.na(high_exp) & !is.na(parent_exp), parent_exp, high_exp)) |>
  ## Drop is high_exp is still NA (neither parent or student answered)
  filter(!is.na(high_exp)) |>
  ## Group the results by region
  group_by(x1region) |>
  ## Get the mean of high_exp (by region)
  summarize(mean_exp = mean(high_exp))
```

::: {.cell-output .cell-output-stdout}

```
# A tibble: 4 × 2
  x1region mean_exp
     <dbl>    <dbl>
1        1     7.39
2        2     7.17
3        3     7.36
4        4     7.13
```


:::
:::


- Now, let's see what that looks like in `SQL`
- First, we have to simulate an `SQL` database for `dbplyr`
  - This tells `dbplyr` exactly how to translate our code
  - For today's class, we will simulate a Microsoft Access database with the `simulate_access()` command
- Second, instead of a normal `df`, we want R to pretend that `df` is a table in a database, which we do with the `memdb_frame()` command
  - If you're curious what this command does, try `print(df)` and `print(db)` to see the difference




::: {.cell}

```{.r .cell-code}
microsoft_access <- simulate_access()

db <- memdb_frame(df)
```
:::


- Now, let's use `dbplyr`'s `show_query()` function to see what this task would look like in `SQL`
  - It's a little overwhelming, particularly because it's nested code (show some appreciation for the `|>` pipe)
    - Honestly, you wouldn't often do something with this many steps in `SQL`
  - But, as we walk through it piece by piece, you will see a lot of similarities to the `R` code we wrote


::: {.cell}

```{.r .cell-code}
db |>
  ## select columns we want
  select(stu_id, x1stuedexpct, x1paredexpct, x1region) |>
  ## If expectation is -8, -9. or 11, make it NA
  mutate(student_exp = ifelse(x1stuedexpct %in% list(-8, -9, 11), NA, x1stuedexpct),
         parent_exp = ifelse(x1paredexpct %in% list(-8, -9, 11), NA, x1paredexpct)) |>
  ## Make a new variable called high_exp that is the higher or parent and student exp
  mutate(high_exp = ifelse(student_exp > parent_exp, student_exp, parent_exp)) |>
  ## If one exp is NA but the other isn't, keep the value not the NA
  mutate(high_exp = ifelse(is.na(high_exp) & !is.na(student_exp), student_exp, high_exp),
         high_exp = ifelse(is.na(high_exp) & !is.na(parent_exp), parent_exp, high_exp)) |>
  ## Drop is high_exp is still NA (neither parent or student answereed)
  filter(!is.na(high_exp)) |>
  ## Group the results by region
  group_by(x1region) |>
  ## Get the mean of high_exp (by region)
  summarize(mean_exp = mean(high_exp)) |>
  show_query()
```

::: {.cell-output .cell-output-stdout}

```
<SQL>
SELECT `x1region`, AVG(`high_exp`) AS `mean_exp`
FROM (
  SELECT `q01`.*
  FROM (
    SELECT
      `stu_id`,
      `x1stuedexpct`,
      `x1paredexpct`,
      `x1region`,
      `student_exp`,
      `parent_exp`,
      CASE WHEN ((`high_exp` IS NULL) AND NOT((`parent_exp` IS NULL))) THEN `parent_exp` WHEN NOT ((`high_exp` IS NULL) AND NOT((`parent_exp` IS NULL))) THEN `high_exp` END AS `high_exp`
    FROM (
      SELECT
        `stu_id`,
        `x1stuedexpct`,
        `x1paredexpct`,
        `x1region`,
        `student_exp`,
        `parent_exp`,
        CASE WHEN ((`high_exp` IS NULL) AND NOT((`student_exp` IS NULL))) THEN `student_exp` WHEN NOT ((`high_exp` IS NULL) AND NOT((`student_exp` IS NULL))) THEN `high_exp` END AS `high_exp`
      FROM (
        SELECT
          `q01`.*,
          CASE WHEN (`student_exp` > `parent_exp`) THEN `student_exp` WHEN NOT (`student_exp` > `parent_exp`) THEN `parent_exp` END AS `high_exp`
        FROM (
          SELECT
            `stu_id`,
            `x1stuedexpct`,
            `x1paredexpct`,
            `x1region`,
            CASE WHEN (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1stuedexpct` END AS `student_exp`,
            CASE WHEN (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1paredexpct` END AS `parent_exp`
          FROM `dbplyr_002`
        ) AS `q01`
      ) AS `q01`
    ) AS `q01`
  ) AS `q01`
  WHERE (NOT((`high_exp` IS NULL)))
) AS `q01`
GROUP BY `x1region`
```


:::
:::


#### Step-by-Step Breakdown





1. First, we selected our four variables from `dbplyr_001` (which is our database `db`)


::: {.cell}

```{.r .cell-code}
db |>
  ## select columns we want
  select(stu_id, x1stuedexpct, x1paredexpct, x1region) |>
  show_query()
```

::: {.cell-output .cell-output-stdout}

```
<SQL>
SELECT `stu_id`, `x1stuedexpct`, `x1paredexpct`, `x1region`
FROM `dbplyr_002`
```


:::
:::


2. Second, we add in `CASE WHEN` statements, that work in place of our `ifelse()` statements to replace -8 -9 and 11 with `NA` (`NULL` in SQL-speak)
  - These actually work just like the `case_when()` function we covered in the first part of the class


::: {.cell}

```{.r .cell-code}
db |>
  ## select columns we want
  select(stu_id, x1stuedexpct, x1paredexpct, x1region) |>
  ## If expectation is -8, -9. or 11, make it NA
  mutate(student_exp = ifelse(x1stuedexpct %in% list(-8, -9, 11), NA, x1stuedexpct),
         parent_exp = ifelse(x1paredexpct %in% list(-8, -9, 11), NA, x1paredexpct)) |>
  show_query()
```

::: {.cell-output .cell-output-stdout}

```
<SQL>
SELECT
  `stu_id`,
  `x1stuedexpct`,
  `x1paredexpct`,
  `x1region`,
  CASE WHEN (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1stuedexpct` END AS `student_exp`,
  CASE WHEN (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1paredexpct` END AS `parent_exp`
FROM `dbplyr_002`
```


:::
:::


3. Okay, all we have done here is add in the line that creates our `high_exp` variable (see the first full line of code)
  - The confusing part is that `dbplyr` has created `q01` and `SELECT`-ed everything `.*` from it
    - This (and any of time you see `q01`) is just a bit like if we assigned something into a new object midway through processing


::: {.cell}

```{.r .cell-code}
db |>
  ## select columns we want
  select(stu_id, x1stuedexpct, x1paredexpct, x1region) |>
  ## If expectation is -8, -9. or 11, make it NA
  mutate(student_exp = ifelse(x1stuedexpct %in% list(-8, -9, 11), NA, x1stuedexpct),
         parent_exp = ifelse(x1paredexpct %in% list(-8, -9, 11), NA, x1paredexpct)) |>
  ## Make a new variable called high_exp that is the higher or parent and student exp
  mutate(high_exp = ifelse(student_exp > parent_exp, student_exp, parent_exp)) |>
  show_query()
```

::: {.cell-output .cell-output-stdout}

```
<SQL>
SELECT
  `q01`.*,
  CASE WHEN (`student_exp` > `parent_exp`) THEN `student_exp` WHEN NOT (`student_exp` > `parent_exp`) THEN `parent_exp` END AS `high_exp`
FROM (
  SELECT
    `stu_id`,
    `x1stuedexpct`,
    `x1paredexpct`,
    `x1region`,
    CASE WHEN (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1stuedexpct` END AS `student_exp`,
    CASE WHEN (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1paredexpct` END AS `parent_exp`
  FROM `dbplyr_002`
) AS `q01`
```


:::
:::


4. Here's where things become hard to untangle, mostly because `dbplyr` keeps assigning the results to `q01` then `SELECT`-ing everything back
  - If you made it this far, you've got the main point of this exercise, so don't worry if this becomes too confusing
  - This step we added the first two longer blocks of code that `SELECT` our variables again (as the previous step's output was saved back to `q01`) then perform a `CASE WHEN` that's equivalent to our `ifelse()` statements that took the non-`NA` value if from parent/student expectations if the other was `NA` (`NULL` in SQL-speak)


::: {.cell}

```{.r .cell-code}
db |>
  ## select columns we want
  select(stu_id, x1stuedexpct, x1paredexpct, x1region) |>
  ## If expectation is -8, -9. or 11, make it NA
  mutate(student_exp = ifelse(x1stuedexpct %in% list(-8, -9, 11), NA, x1stuedexpct),
         parent_exp = ifelse(x1paredexpct %in% list(-8, -9, 11), NA, x1paredexpct)) |>
  ## Make a new variable called high_exp that is the higher or parent and student exp
  mutate(high_exp = ifelse(student_exp > parent_exp, student_exp, parent_exp)) |>
  ## If one exp is NA but the other isn't, keep the value not the NA
  mutate(high_exp = ifelse(is.na(high_exp) & !is.na(student_exp), student_exp, high_exp),
         high_exp = ifelse(is.na(high_exp) & !is.na(parent_exp), parent_exp, high_exp)) |>
  show_query()
```

::: {.cell-output .cell-output-stdout}

```
<SQL>
SELECT
  `stu_id`,
  `x1stuedexpct`,
  `x1paredexpct`,
  `x1region`,
  `student_exp`,
  `parent_exp`,
  CASE WHEN ((`high_exp` IS NULL) AND NOT((`parent_exp` IS NULL))) THEN `parent_exp` WHEN NOT ((`high_exp` IS NULL) AND NOT((`parent_exp` IS NULL))) THEN `high_exp` END AS `high_exp`
FROM (
  SELECT
    `stu_id`,
    `x1stuedexpct`,
    `x1paredexpct`,
    `x1region`,
    `student_exp`,
    `parent_exp`,
    CASE WHEN ((`high_exp` IS NULL) AND NOT((`student_exp` IS NULL))) THEN `student_exp` WHEN NOT ((`high_exp` IS NULL) AND NOT((`student_exp` IS NULL))) THEN `high_exp` END AS `high_exp`
  FROM (
    SELECT
      `q01`.*,
      CASE WHEN (`student_exp` > `parent_exp`) THEN `student_exp` WHEN NOT (`student_exp` > `parent_exp`) THEN `parent_exp` END AS `high_exp`
    FROM (
      SELECT
        `stu_id`,
        `x1stuedexpct`,
        `x1paredexpct`,
        `x1region`,
        CASE WHEN (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1stuedexpct` END AS `student_exp`,
        CASE WHEN (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1paredexpct` END AS `parent_exp`
      FROM `dbplyr_002`
    ) AS `q01`
  ) AS `q01`
) AS `q01`
```


:::
:::


5. Here we added 2 lines of substance (`FROM (` just links to rest of the code)
- First line: `SELECT q01.*`
  - Select everything from q01 (a temporary object saved from the last step)
- Last line: ``WHERE (NOT((`high_exp` IS NULL)))``
  - Same as `filter(!is.na(high_exp))`
- Note: the reason it's the first and last lines is that everything we have done so far is nested in the middle
  - Revisit the introduction to the `|>` pipe in [Data Wrangling I](03-wrangle-i.qmd) for refresher on nested code



::: {.cell}

```{.r .cell-code}
db |>
  ## select columns we want
  select(stu_id, x1stuedexpct, x1paredexpct, x1region) |>
  ## If expectation is -8, -9. or 11, make it NA
  mutate(student_exp = ifelse(x1stuedexpct %in% list(-8, -9, 11), NA, x1stuedexpct),
         parent_exp = ifelse(x1paredexpct %in% list(-8, -9, 11), NA, x1paredexpct)) |>
  ## Make a new variable called high_exp that is the higher or parent and student exp
  mutate(high_exp = ifelse(student_exp > parent_exp, student_exp, parent_exp)) |>
  ## If one exp is NA but the other isn't, keep the value not the NA
  mutate(high_exp = ifelse(is.na(high_exp) & !is.na(student_exp), student_exp, high_exp),
         high_exp = ifelse(is.na(high_exp) & !is.na(parent_exp), parent_exp, high_exp)) |>
  ## Drop is high_exp is still NA (neither parent or student answereed)
  filter(!is.na(high_exp)) |>
  show_query()
```

::: {.cell-output .cell-output-stdout}

```
<SQL>
SELECT `q01`.*
FROM (
  SELECT
    `stu_id`,
    `x1stuedexpct`,
    `x1paredexpct`,
    `x1region`,
    `student_exp`,
    `parent_exp`,
    CASE WHEN ((`high_exp` IS NULL) AND NOT((`parent_exp` IS NULL))) THEN `parent_exp` WHEN NOT ((`high_exp` IS NULL) AND NOT((`parent_exp` IS NULL))) THEN `high_exp` END AS `high_exp`
  FROM (
    SELECT
      `stu_id`,
      `x1stuedexpct`,
      `x1paredexpct`,
      `x1region`,
      `student_exp`,
      `parent_exp`,
      CASE WHEN ((`high_exp` IS NULL) AND NOT((`student_exp` IS NULL))) THEN `student_exp` WHEN NOT ((`high_exp` IS NULL) AND NOT((`student_exp` IS NULL))) THEN `high_exp` END AS `high_exp`
    FROM (
      SELECT
        `q01`.*,
        CASE WHEN (`student_exp` > `parent_exp`) THEN `student_exp` WHEN NOT (`student_exp` > `parent_exp`) THEN `parent_exp` END AS `high_exp`
      FROM (
        SELECT
          `stu_id`,
          `x1stuedexpct`,
          `x1paredexpct`,
          `x1region`,
          CASE WHEN (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1stuedexpct` END AS `student_exp`,
          CASE WHEN (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1paredexpct` END AS `parent_exp`
        FROM `dbplyr_002`
      ) AS `q01`
    ) AS `q01`
  ) AS `q01`
) AS `q01`
WHERE (NOT((`high_exp` IS NULL)))
```


:::
:::


6. Finally, we want to get our mean expectation by region, so we add 2 lines of substance again
  - Last line: ``GROUP BY `x1region``
    - Group the data by region
  - First line: ``SELECT `x1region`, AVG(`high_exp`) AS `mean_exp``
    - Taking `x1region` as the first column and the `AVG` (mean) of `high_exp` as the second column


::: {.cell}

```{.r .cell-code}
db |>
  ## select columns we want
  select(stu_id, x1stuedexpct, x1paredexpct, x1region) |>
  ## If expectation is -8, -9. or 11, make it NA
  mutate(student_exp = ifelse(x1stuedexpct %in% list(-8, -9, 11), NA, x1stuedexpct),
         parent_exp = ifelse(x1paredexpct %in% list(-8, -9, 11), NA, x1paredexpct)) |>
  ## Make a new variable called high_exp that is the higher or parent and student exp
  mutate(high_exp = ifelse(student_exp > parent_exp, student_exp, parent_exp)) |>
  ## If one exp is NA but the other isn't, keep the value not the NA
  mutate(high_exp = ifelse(is.na(high_exp) & !is.na(student_exp), student_exp, high_exp),
         high_exp = ifelse(is.na(high_exp) & !is.na(parent_exp), parent_exp, high_exp)) |>
  ## Drop is high_exp is still NA (neither parent or student answered)
  filter(!is.na(high_exp)) |>
  ## Group the results by region
  group_by(x1region) |>
  summarize(mean_exp = mean(high_exp)) |>
  show_query()
```

::: {.cell-output .cell-output-stdout}

```
<SQL>
SELECT `x1region`, AVG(`high_exp`) AS `mean_exp`
FROM (
  SELECT `q01`.*
  FROM (
    SELECT
      `stu_id`,
      `x1stuedexpct`,
      `x1paredexpct`,
      `x1region`,
      `student_exp`,
      `parent_exp`,
      CASE WHEN ((`high_exp` IS NULL) AND NOT((`parent_exp` IS NULL))) THEN `parent_exp` WHEN NOT ((`high_exp` IS NULL) AND NOT((`parent_exp` IS NULL))) THEN `high_exp` END AS `high_exp`
    FROM (
      SELECT
        `stu_id`,
        `x1stuedexpct`,
        `x1paredexpct`,
        `x1region`,
        `student_exp`,
        `parent_exp`,
        CASE WHEN ((`high_exp` IS NULL) AND NOT((`student_exp` IS NULL))) THEN `student_exp` WHEN NOT ((`high_exp` IS NULL) AND NOT((`student_exp` IS NULL))) THEN `high_exp` END AS `high_exp`
      FROM (
        SELECT
          `q01`.*,
          CASE WHEN (`student_exp` > `parent_exp`) THEN `student_exp` WHEN NOT (`student_exp` > `parent_exp`) THEN `parent_exp` END AS `high_exp`
        FROM (
          SELECT
            `stu_id`,
            `x1stuedexpct`,
            `x1paredexpct`,
            `x1region`,
            CASE WHEN (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1stuedexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1stuedexpct` END AS `student_exp`,
            CASE WHEN (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN NULL WHEN NOT (`x1paredexpct` IN list(-8.0, -9.0, 11.0)) THEN `x1paredexpct` END AS `parent_exp`
          FROM `dbplyr_002`
        ) AS `q01`
      ) AS `q01`
    ) AS `q01`
  ) AS `q01`
  WHERE (NOT((`high_exp` IS NULL)))
) AS `q01`
GROUP BY `x1region`
```


:::
:::


- There we have it, a walk through our first data wrangling session translated into `SQL`
  - By no means are expected to have any working knowledge of `SQL` from this
  - The point is to demonstrate how similar they are, and get your toes wet if you're interested in developing `SQL` skills (as any future institutional researchers should be)

- Next, we will explore `Data Wrangling II` to see how `SQL` can be used for joining data

#### Pivot-Longer with Compound Names





- Finally, let's read in our an extra-wide version of our data into `df_3` and turn it into a simulated database


::: {.cell}

```{.r .cell-code}
df_3 <- read_csv(file.path("data", "sch-test", "all-schools-wide.csv"))

db_3 <- memdb_frame(df_3)

print(db_3)
```

::: {.cell-output .cell-output-stdout}

```
# Source:   table<dbplyr_003> [4 x 19]
# Database: sqlite 3.45.0 [:memory:]
  school       math_1980 read_1980 science_1980 math_1981 read_1981 science_1981
  <chr>            <dbl>     <dbl>        <dbl>     <dbl>     <dbl>        <dbl>
1 Bend Gate          515       281          808       503       312          814
2 East Heights       501       318          782       487       323          813
3 Niagara            514       292          787       499       268          762
4 Spottsville        498       288          813       494       270          765
# ℹ 12 more variables: math_1982 <dbl>, read_1982 <dbl>, science_1982 <dbl>,
#   math_1983 <dbl>, read_1983 <dbl>, science_1983 <dbl>, math_1984 <dbl>,
#   read_1984 <dbl>, science_1984 <dbl>, math_1985 <dbl>, read_1985 <dbl>,
#   science_1985 <dbl>
```


:::
:::


- Now using the `contains()` function to `pivot_longer()` any columns with 19 in the name (all but school name)
- We then take the column names and split (`names_sep`) them by the `_` putting the first half into new column `test` and the second half into new column `year`, with the values from all cells going into new column `score`


::: {.cell}

```{.r .cell-code}
## Note: change from DWII,dbplyr can't translate separate, or any stringr commands, so we have to be more sophisticated with our pivot_longer
df_long_fix <- db_3 |>
    ## NB: contains() looks for "19" in name: if there, it adds it to cols
    pivot_longer(cols = contains("19"),
                 names_to = c("test", "year"),
                 names_sep = "_",
                 values_to = "score") |>
  show_query()
```

::: {.cell-output .cell-output-stdout}

```{.SQL}
<SQL>
SELECT `school`, 'math' AS `test`, '1980' AS `year`, `math_1980` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'read' AS `test`, '1980' AS `year`, `read_1980` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT
  `school`,
  'science' AS `test`,
  '1980' AS `year`,
  `science_1980` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'math' AS `test`, '1981' AS `year`, `math_1981` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'read' AS `test`, '1981' AS `year`, `read_1981` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT
  `school`,
  'science' AS `test`,
  '1981' AS `year`,
  `science_1981` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'math' AS `test`, '1982' AS `year`, `math_1982` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'read' AS `test`, '1982' AS `year`, `read_1982` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT
  `school`,
  'science' AS `test`,
  '1982' AS `year`,
  `science_1982` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'math' AS `test`, '1983' AS `year`, `math_1983` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'read' AS `test`, '1983' AS `year`, `read_1983` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT
  `school`,
  'science' AS `test`,
  '1983' AS `year`,
  `science_1983` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'math' AS `test`, '1984' AS `year`, `math_1984` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'read' AS `test`, '1984' AS `year`, `read_1984` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT
  `school`,
  'science' AS `test`,
  '1984' AS `year`,
  `science_1984` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'math' AS `test`, '1985' AS `year`, `math_1985` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT `school`, 'read' AS `test`, '1985' AS `year`, `read_1985` AS `score`
FROM `dbplyr_003`

UNION ALL

SELECT
  `school`,
  'science' AS `test`,
  '1985' AS `year`,
  `science_1985` AS `score`
FROM `dbplyr_003`
```


:::
:::


- Similarly to our previous pivot longer, we see the `SQL` effectively just creates a series of queries, one for each year/subject combination, then `UNION ALL` stacks them all together


-->



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://capaldi.info">
<p>M.J. Capaldi</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://quarto.org/docs/websites">
<p>Built with Quarto</p>
</a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ttalVlatt/7916">
      <i class="bi bi-github" role="img" aria-label="Website Code Available Here">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>